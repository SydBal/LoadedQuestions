<!--  Dominic Balassone
  Lock and Load
  -->
<html ng-app="myApp" lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/public/img/bubble.png"/>
    <meta name="description" content="Don't shoot yourself in the foot!">
    <meta name="author" content="Dominic Balassone">
    <title>Loaded Questions</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- Angular -->
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>
    <!-- underscoee -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">    
    <!--Custom CSS-->
    <style type="text/css">
      body{
        word-wrap: break-word;
      }
      .shadow {
        -webkit-box-shadow: 0px 2px 4px 0px #ccc;  /* Safari 3-4, iOS 4.0.2 - 4.2, Android 2.3+ */
        -moz-box-shadow:    0px 2px 4px 0px #ccc;  /* Firefox 3.5 - 3.6 */
        box-shadow:         0px 2px 4px 0px #ccc;  /* Opera 10.5, IE 9, Firefox 4+, Chrome 6+, iOS 5 */
      }
    	.halfscreen{
    		position:relative;
    		height:50%;
    		margin-bottom: 0;
    		text-align: center;
    		overflow-y: auto;
        text-shadow: 1px 1px #ff0000;
        padding-top:20px;
    	}
    	#topTron{
    		height:35%;
    		background-color: navy;
    		color: white;
        display:none;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        z-index: 10;
    	}
      #helpbutton{
        position: absolute;
        right:0;
        top:0;
        background-color: rgba(0,0,0,0);
        text-shadow: none;
        color:rgba(0,0,0,.3);
        font-size:3em;
        margin:2px;
        cursor: default;
        z-index: 102
      }
    	#botTron{
    		height:65%;
    		color: navy;
        display:none;
        background-color:white;
        overflow-x: auto;
        overflow-y: auto;
    	}
    	#topText{
    		width:100%;
    		text-align: center;
    		position: absolute;
    		bottom:0;
    		margin-bottom: 5px;
    		max-height: 100%;
        display:none;
    	}
    	#botText{
    		width:100%;
    		text-align: center;
    		position: absolute;
    		top:0;
    		overflow-y: auto;
    	}
    	.gamebtn{
    		color:navy;
    		background-color:rgba(0,0,0,0);
    		text-shadow: 1px 1px #ff0000;
    		border:solid;border-radius:2px;
    		border-width: 1.5px;
    		margin:8px;
    		padding:6px 12px;
    	}
      .rnd-gb{
        border-width: 2px;
        text-shadow: none;
      }
    	#instr{
    		text-shadow: none;    		
    	}
      #playersignup {
        display:none;
      }
      #playersignupinput {
        color:navy;
        background-color:rgba(0,0,0,0);
        margin:18px 8px;
        padding:2px;
        border:solid;
        border-radius:2px;
        border-width: 1px;
        max-width: 50%;
        margin-right: 0

      }
      #askquestioninput {
        color:navy;
        background-color:rgba(0,0,0,0);
        margin:18px 8px;
        padding:2px;
        padding-bottom: 2px;
        border:solid;
        border-radius:2px;
        border-width: 1px;
        max-width: 50%

      }
      #playersignuplist{
        text-shadow: none;
        list-style: none;
        padding:0;
        margin-top:0px;
        margin-bottom: 2px;
        word-wrap: break-word;
      }
      #addplayerbtn{
        border-radius: 100%;
        background-color: rgba(0,220,0,1);
        margin-left:0px;
        padding:6px;
        display:inline-flex;
      }
      #askquestionbtn{
        border-radius: 100%;
        background-color: rgba(0,220,0,1);
        margin-left:0px;
        padding:6px;
        display:inline-flex;
      }
      #guessquestionbtn{
        border-radius: 100%;
        background-color: yellow;
        margin-left:0px;
        padding:6px;
        display:inline-flex;
      }
      #removeplayerbtn{
        border-radius: 100%;
        margin:2px 6px;
        background-color: rgba(255,0,0,1);
        margin-left:0px;
        padding:6px;
      }
      #addanswerbtn{
        border-radius: 100%;
        background-color: rgba(0,220,0,1);
        margin-left:0px;
        padding:6px;
        display:inline-flex;
      }
      th, td {
        padding: 5px;
      }
      tr:nth-child(even){background-color: #f9f9f9}
      tr:nth-child(odd){background-color: #FFFFFF}
      #playertabletoggle{
        right:0;
        top:0;
        position:fixed;
        z-index: 101;
        overflow-x:auto;
        max-width: 100%;
        display:none;
      }
      #flex-input{
        display: flex;
      }
      .guesses{
        margin-bottom: 5px;
        border-top:1px solid #3A5FCD;
        max-width: 50%;
        margin-left:auto;
        margin-right: auto;
        min-width: 300px;
      }
      #guesswrap .guesses:first-child{
        border-top: none;
      }
    </style>
  </head>
  <body ng-controller="myController">
    <!--
    ScoreToggle
    -->
    <i id="helpbutton" class="material-icons" style="display:none;" ng-click="showHelpMenu()">help</i>
    <div id="playertabletoggle" >
      <h4 style="text-shadow: none;margin-top: 0">
      <table align="center" style="margin: 0px auto;text-shadow:none;color:navy;text-align:center;padding:10px;border:1px solid navy;border-radius:10px;padding:10px;" class="shadow">
        <tr style="padding:0px;">
          <th style="text-align:center;"><h3 style="margin-top:10px">Player</h3></th>
          <th><h3 style="margin-top:10px">Points</h3></th>
        </tr>
        <tr ng-repeat="player in players" id="scoretable">
          <td><h4>{{player.name}}</h4></td>
          <td><h4>{{player.score}}</h4></td>
        </tr>
      </table>
    </div>
		<div id="topTron" class="jumbotron halfscreen shadow">
			<div id="topText">				
				<h1>
					<strong><em><span style="text-shadow: 2px 2px #ff0000;">L</span></em></strong>oaded <strong><em><span style="text-shadow: 2px 2px #ff0000;">Q</span></em></strong>uestions
				</h1>
        <h3 id="gamesetuptitle" style="display:none;margin-top: 10px">Who's playing?</h3>
        <h3 id="gamereadytitle" style="display:none;margin-top: 10px">Let's get started</h3>
        <h3 id="gameroundtitle" style="display:none;margin-top: 10px;display:none">Round {{round}}: {{players[turn].name}}{{}}</h3>
        <h3 id="roundquestiontitle" style="display:none;margin-top: 6px">Q: "{{questions[turn].value}}"</h3>
			</div>		
		</div>
		<div id="botTron" class="jumbotron halfscreen">
			<div id="botText">
        <!--
        TITLE SCREEN
        -->
				<div id="titlescreenbot">
					<h3 style="margin-top:10px">
						<button class="gamebtn shadow" id="newgamebtn">New Game</button>
					</h3>
					<div id="instr" style="display:none;">
						<div class="container">
						  What's the best thing you can do with 3 or more people?
						</div>
					</div>
				</div>
        <!--
        SIGN UP
        -->
        <div id="playersignup">
          <h3 style="margin-bottom:0;margin-top:15px;1">
          <ul ng-repeat="player in players" id="playersignuplist">
              <li><!--{{$index + 1}}--><span style="padding:4px 4px;padding-left:4px;max-width: 300px">{{ player.name }}</span><button id="removeplayerbtn" ng-click="removePlayer($index);" class="gamebtn rnd-gb"><i class="material-icons" style="font-size:18px">clear</i></button></li>
          </ul>
          <div id="input-flex">
            <input type="text" id="playersignupinput" ng-keydown="enternewplayer($event)" placeholder="Name" class="shadow">
            <button id="addplayerbtn" ng-click="addPlayer();" class="gamebtn rnd-gb shadow">
              <i class="material-icons" style="font-size:18px">add</i>
            </button>
          </div>
          </h3>
          <div id="playerreq" style="text-shadow: none;color: red;">*Requires >3 Players</div>

          <button ng-click="startgame()" class="gamebtn shadow" style="margin:0;display:none;" id="gamestartbtn"><h3 style="margin:0">Next</h3></button>
        </div>
        <!--
        SCOREBOARD
        -->
        <div id="playertablewrapper" style="display:none;margin-top: 18px">
          <div id="playertable" >
            <h4 style="text-shadow: none;">
            <div style="padding-bottom: 14px">Reach <STRONG style="text-shadow: 1px 1px #ff0000;">{{winScore}}</STRONG> Points to <STRONG style="text-shadow: 1px 1px #ff0000;"">Win!</STRONG></div>
            <table align="center" style="margin: 0px auto;text-shadow:none;color:navy;text-align:center;padding:10px;border:1px solid navy;border-radius:10px;padding:10px;" class="shadow">
              <tr style="padding:0px;">
                <th style="text-align:center;"><h3 style="margin-top:10px">Player</h3></th>
                <th><h3 style="margin-top:10px">Points</h3></th>
              </tr>
              <tr ng-repeat="player in players" id="scoretable">
                <td><h4>{{player.name}}</h4></td>
                <td><h4>{{player.score}}</h4></td>
              </tr>
            </table>
            <h3 style="margin-top:10px">
            <button class="gamebtn shadow" id="tablenext">Start<br>Round 1</button>
            </h3>
          </div>
        </div>
        <!--
        ASK QUESTION
        -->
        <div id="questionaskwrap" style="display:none;text-shadow: none;">
          <h3>
            <strong style="text-shadow:1px 1px red">{{players[turn].name}}</strong>,<br> ask a question.
          </h3>
          <h3 style="margin-top: 10px">
            <input type="text" id="askquestioninput" ng-keydown="enternewquestion($event)" placeholder="?" class="shadow">
            <button id="askquestionbtn" ng-click="askQuestion($event);" class="gamebtn rnd-gb shadow">
              <i class="material-icons" style="font-size:18px">lock_open</i>
            </button>
          </h3>
          <div id="questionreq" style="text-shadow: none;color: red;display:none;">*valid questions end with ?</div>
          <button id="askquestionnext" class="gamebtn shadow" ng-click="submitQuestion()" style="display:none;">
            <h3 style="margin:0;">Next</h3>
          </button>
        </div>
        <!--
        RESPOND
        -->
        <div id="questionrespondwrap" style="display:none;">
          <h4 style="margin-top:20px;text-shadow: none;">Enter and lock in your response to <strong>{{players[turn].name}}</strong>'s question.</h4>
          <div class="responses">
            <div ng-repeat="player in players" ng-if="$index!=turn" class="response">
              <h3 style="margin-top:10px">
                <input type="text" placeholder="{{players[$index].name}}" style="border-radius: 2px; border-color: navy;max-width: 50%; border-width: 1px;padding:2px" class="shadow">
                <button id="addanswerbtn" ng-click="addAnswer($event);" class="gamebtn rnd-gb shadow lock-button">
                  <i class="material-icons" style="font-size:18px">lock_open</i>
                </button>
              </h3>
            </div>
          </div>
          <button id="responseNext" ng-click="submitAnswers()" class="gamebtn shadow" style="display:none" disabled=""><h3 style="margin:0;">Next</h3></button>
        </div>
        <!--
        GUESS
        -->
        <div id="guesswrap" style="display: none;">
          <h3 style="margin-bottom: 12px"><strong>{{players[turn].name}}</strong><span style="text-shadow:none;">, guess who wrote each response.</span></h3>
          <div class="guesses" ng-repeat="answer in answers">
            <p style="margin-bottom:5px;margin-top:15px">"<span style="text-shadow: none;">{{answer.a}}</span>"</p>
            <select style="border:1px solid navy;font-size:1.4em;color:navy;border-radius:2px;padding:2px;max-width: 50%" class="shadow">
              <option value="" disabled selected style="display: none;">Player</option>
              <option ng-repeat="player in players" ng-if="$index!=turn">
                {{player.name}}
              </option>
            </select>
            <button id="guessquestionbtn" ng-click="guessQuestion($event,answer.a);" class="gamebtn rnd-gb shadow">
              <i class="material-icons" style="font-size:18px">lock_open</i>
            </button>
          </div>
        </div>
      </body>

		<!-- Bootstrap core JavaScript-->
		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<!-- Latest compiled BootstrapJS -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<!-- My JS -->
		<script>
			angular.module('myApp', []);

			angular.module('myApp')
			.controller('myController', function ($scope) {

        $scope.players = [];

        $scope.winScore = 0;

        $scope.round = 1;
			  
        $scope.turn = 0;

        $scope.questions = [];

        $scope.answers = [];

        //cool intro
        $(document).ready(function(){
          $("#topTron").slideDown(function(){
            $("#topText").fadeToggle(function(){
              $("#botTron").fadeToggle(function(){
                $("#instr").fadeToggle(2000) 
              })
            })
          })
        })

        //button css
        //buggy
        $(".gamebtn").hover(function(){
          if(this.id!="addplayerbtn"&&this.id!="removeplayerbtn"&&this.id!="askquestionbtn"){
            $(this).css({"background-color":"rgba(0,0,128,.2)"})
          }
        },function(){
          if(this.id=="addplayerbtn"||this.id=="askquestionbtn"){
            //$(this).css({"background-color":"rgba(0,255,0,1)"})
          }else if(this.id=="removeplayerbtn"){
            $(this).css({"background-color":"rgba(255,0,0,1)"})
          }else{
            $(this).css({"background-color":"rgba(0,0,0,0)"})
          }
        });

        //Home screen button press
        $("#newgamebtn").click(function(){
          $("#newgamebtn").attr("disabled", true);
          $("#titlescreenbot").fadeToggle(function(){
            $("#playersignup").fadeToggle(100)
            $("#gamesetuptitle").slideDown()
          })
        })

        //Add a player to the player list
        $scope.addPlayer = function(){
          if($('#playersignupinput').val() != ''){
            $scope.players.push({name:$("#playersignupinput").val(),"score":0})
            $("#playersignupinput").val('');
            if($scope.players.length==3){
              $("#playerreq").fadeToggle(function(){
                $('#gamestartbtn').fadeIn();
              });
            };
          };
        };

        //Remove an already added player from the list
        $scope.removePlayer = function(i){
          $scope.players[i]
          $scope.players.splice(i, 1);
          if($scope.players.length==2){
            $('#gamestartbtn').fadeOut(function(){
              $("#playerreq").fadeToggle();
            });
          };
        };

        //player creation input using enter key
        $scope.enternewplayer = function(event){
          if (event.which == 13) {
            $scope.addPlayer();
          };
        };

        //Once all players are added, NEXT button press
        $scope.startgame =function(){
          $scope.winScore = 2 * ($scope.players.length-1);
          $("#gamestartbtn").attr("disabled", true);
          $("#gamesetuptitle").slideToggle(function(){
            $("#gamereadytitle").slideToggle();
          });
          $('#playersignup').fadeToggle(function(){
            //show score to win and score table
            $("#playertablewrapper").fadeToggle();
          });
        };

        //Table NEXT button press
        $("#tablenext").click(function(){
          $("#tablenext").attr("disabled", true);     
          $("#helpbutton").fadeToggle(3000)
          $("#playertablewrapper").fadeToggle()
          $('#gamereadytitle').slideToggle(function(){
            $("#gameroundtitle").slideToggle()
            $("#questionaskwrap").fadeToggle()
          })
        })			  

        //Help menu button press
        $scope.showHelpMenu = function(){
          $("#playertabletoggle").slideToggle()
        }

        //lock in question, or unlock
        $scope.askQuestion = function(event){
          if($('#askquestioninput').val() != ''){
            if($('#askquestioninput').val().substr($('#askquestioninput').val().length-1)=="?"){
              btn_clicked=event.currentTarget;
              var questionInput = $(btn_clicked).closest('h3').find('input')
              if(btn_clicked.locked==undefined||btn_clicked.locked==false){
                btn_clicked.style.background = "red"
                btn_clicked.locked = true;
                $('#askquestionnext').prop("disabled",false)
                $("#questionreq").fadeOut(function(){
                  $('#askquestionnext').fadeToggle()
                })
                btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock</i>';
                questionInput.prop("disabled", true);
              }else{
                btn_clicked.style.background = "rgba(0,220,0,1)"
                btn_clicked.locked = false;
                $('#askquestionnext').prop("disabled",true)
                $('#askquestionnext').fadeToggle()
                btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock_open</i>';
                questionInput.prop("disabled", false);
              };
            }else{
              $("#questionreq").fadeIn()
            };
          };
        };

        //Once question is locked in NEXT button press
        $scope.submitQuestion = function(){
          $("#askquestioninput").attr("disabled", true);
          $("#askquestionbtn").attr("disabled", true);
          $scope.questions.push({value:$('#askquestioninput').val(),askedBy:$scope.players[$scope.turn].name})
          $("#questionaskwrap").fadeToggle(function(){
            $("#respondwrap").fadeToggle()
            $("#roundquestiontitle").slideToggle()
            $("#questionrespondwrap").fadeToggle()
          });
        }

        //lock in for player responses
        $scope.addAnswer = function(event){
          //check if all answers are locked in (before and after changing the lock)
          var areAnswersSubmitted = function(){
            var answers = $('#questionrespondwrap').find('input');
            //returns true if everyone has responded
            if(answers.length==answers.filter(":disabled").length){
                $('#responseNext').fadeToggle()
                $('#responseNext').prop('disabled', function(i, v) { return !v; });
            };
          }

          areAnswersSubmitted();
          btn_clicked=event.currentTarget;
          var answerInput = $(btn_clicked).closest('h3').find('input');
          if(answerInput.val()!=''){
            if(btn_clicked.locked==undefined||btn_clicked.locked==false){
              btn_clicked.style.background = "red"
              btn_clicked.locked = true;
              $('#askquestionnext').prop("disabled",false);
              $("#questionreq").fadeOut(function(){
                $('#askquestionnext').fadeToggle();
              })
              btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock</i>';
              $(btn_clicked).toggleClass('locked');
              answerInput.prop("disabled", true);
              answerInput.attr('type', 'password'); 
            }else{
              btn_clicked.style.background = "rgba(0,220,0,1)"
              btn_clicked.locked = false;
              $('#askquestionnext').prop("disabled",true)
              $('#askquestionnext').fadeToggle()
              btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock_open</i>';
              $(btn_clicked).toggleClass('locked');
              answerInput.prop("disabled", false);
              answerInput.attr('type', 'text');
            };
            areAnswersSubmitted();
          };
        };

        $scope.submitAnswers = function(){
          var answers = $('#questionrespondwrap').find('input')
          //for each answer input field, get the response
          /*
            [
             {
              name: (player), 
              a   : (answer)
             },
             {...},
             ...
            ]
          */
          //randomize the order to make guessing more difficult (make rendering angular easier!)
          //http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
          function shuffleArray(array) {
              for (var i = array.length - 1; i > 0; i--) {
                  var j = Math.floor(Math.random() * (i + 1));
                  var temp = array[i];
                  array[i] = array[j];
                  array[j] = temp;
              }
              return array;
          }

          var answersUnshuffled = []
          $('.response input').each(function(i,value){
            answersUnshuffled[i] = {name:$(this).attr('placeholder'),a:$(this).val()}
          })
          $scope.answers = shuffleArray(answersUnshuffled)
          $('#questionrespondwrap').fadeToggle(function(){
            $('#guesswrap').fadeToggle()
          });
        };

        $scope.guessQuestion = function(event,answer){
          btn_clicked=event.currentTarget;
          var guessfield = $(btn_clicked).closest('.guesses').find('select')
          if(guessfield.val()!=null){
            $(guessfield).prop("disabled", true);
            $(guessfield).css({"background-color":"lightgrey"});
            $(btn_clicked).prop("disabled", true);
            btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock</i>';
            var guess = $(btn_clicked).closest('.guesses').find('select').val().trim();
            var actual = '';
            for (var i = $scope.answers.length - 1; i >= 0; i--) {
              if($scope.answers[i].a==answer){
                if($scope.answers[i].name==guess){
                  btn_clicked.style.background = "rgba(0,220,0,1)"
                    }else{
                  btn_clicked.style.background = "red"
                }
              }
            }
          }

          /*if(answerInput.val()!=''){
            if(btn_clicked.locked==undefined||btn_clicked.locked==false){
              btn_clicked.style.background = "red"
              btn_clicked.locked = true;
              $('#askquestionnext').prop("disabled",false);
              $("#questionreq").fadeOut(function(){
                $('#askquestionnext').fadeToggle();
              })
              btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock</i>';
              $(btn_clicked).toggleClass('locked');
              answerInput.prop("disabled", true);
              answerInput.attr('type', 'password'); 
            }else{
              btn_clicked.style.background = "rgba(0,220,0,1)"
              btn_clicked.locked = false;
              $('#askquestionnext').prop("disabled",true)
              $('#askquestionnext').fadeToggle()
              btn_clicked.innerHTML = '<i class="material-icons" style="font-size:18px">lock_open</i>';
              $(btn_clicked).toggleClass('locked');
              answerInput.prop("disabled", false);
              answerInput.attr('type', 'text');
            };*/
        };
			});
		</script>
  </body>
</html>